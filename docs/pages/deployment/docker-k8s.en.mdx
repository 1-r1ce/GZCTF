import { Callout } from "nextra-theme-docs";

# Separated Deployment with Docker and K8s

Here we use the lightweight K3s as an example. If you have already deployed a K8s cluster, you can refer to the subsequent configuration for similar settings.

<Callout type="warning">

Please read the entire tutorial before proceeding, otherwise the deployment result may not meet expectations.

</Callout>

## Install Docker

You can find the installation instructions on the [Docker official website](https://docs.docker.com/engine/install/), and use the basic configuration in [Quick Start](/quick-start) to run GZCTF.

## Install K3s

K3s is a lightweight k8s distribution that can be quickly deployed on single and multiple machines. Official documentation: [https://docs.k3s.io/](https://docs.k3s.io/)

<Callout type="info">

If you only have one machine and want to run GZCTF through Docker, you can specify the Docker backend by adding the following parameters during installation:

```bash
INSTALL_K3S_EXEC="--docker"
```

And install k3s in the following way. For more information, please refer to [k3s installation configuration](https://docs.k3s.io/installation/configuration):

```bash
curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_EXEC="..." sh -
```

But this is not recommended, using Docker as a container backend may cause some functions to be unavailable.

If you don't want to use Docker as a container backend, but need to deploy on a single machine, you can refer to the method in [K8s Cluster Deployment](/deployment/k8s-only).

</Callout>

```bash
curl -sfL https://get.k3s.io | sh -
# Check for Ready node, takes ~30 seconds
sudo k3s kubectl get node
```

<Callout type="info">

It can be installed from a mirror site if you have trouble accessing the official website.

```bash
curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -
```

</Callout>

多机安装和集群组建请参考 [官方文档](https://docs.k3s.io/zh/quick-start)。

## 配置 GZCTF

k3s 的连接配置文件位于 `/etc/rancher/k3s/k3s.yaml`，可以使用以下命令导出：

```bash
sudo cat /etc/rancher/k3s/k3s.yaml
```

使用如下命令获取 k3s control-panel 所在机器的 IP：

```bash
sudo k3s kubectl cluster-info
```

<Callout type="info">

若显示 `127.0.0.1` 则说明 k3s control-panel 就是当前的机器，请使用 `ip a` 查看当前机器的 IP。

你可以直接使用 IP 地址，或者使用域名，但是需要确保域名解析到 k3s control-panel 所在的机器，确保 GZCTF 的机器可以访问它的 6443 端口。

</Callout>

将上述输出的内容保存为 `kube-config.yaml`，并更改 `server` 字段为 k3s control-panel 所在机器的 IP，例如

```yaml
apiVersion: v1
clusters:
  - cluster:
      certificate-authority-data: # ...
      server: https://127.0.0.1:6443 # change this to your k3s control-panel's IP or domain
    name: default
# ...
```

将其存储至部署 GZCTF 的机器上，和 `docker-compose.yml` 在一个文件夹内，例如 `kube-config.yaml`。
之后更改 `docker-compose.yml` 中的挂载信息：

```yaml
gzctf:
  image: gztime/gzctf:latest
  restart: always
  ports:
    - "80:80"
  networks:
    default:
  volumes:
    - "./data/files:/app/files"
    - "./appsettings.json:/app/appsettings.json:ro"
    - "./kube-config.yaml:/app/kube-config.yaml:ro" # this is required for k8s deployment
    # - "/var/run/docker.sock:/var/run/docker.sock" # this is required for docker deployment
  depends_on:
    - db
```

同时更改 `appsettings.json`，设置 `ContainerProvider` 字段：

```json
{
  "Type": "Kubernetes",
  "PublicEntry": "ctf.example.com" // change this to your k3s control-panel's IP or domain
}
```

重新启动 GZCTF，之后就可以使用 k3s 作为容器后端了。已经使用过 k8s 的用户也可以参考上述的配置过程，让 GZCTF 接入现有的 k8s 集群。

## 更改 NodePort 端口范围

k3s 默认的 NodePort 端口范围为 30000-32767，这可能会与需求不太符合，因此可以根据需要更改 k3s 的 NodePort 端口范围。

在 k3s control-panel 所在的机器上执行以下命令：

- `sudo nano /etc/systemd/system/k3s.service`
- 编辑如下设置中的 `ExecStart`，指定`service-node-port-range`

  ```bash
  ExecStart=/usr/local/bin/k3s \
      server \
      --kube-apiserver-arg service-node-port-range=20000-50000
  ```

- `sudo systemctl daemon-reload`
- `sudo systemctl restart k3s`

## 更改 K3s 的容器数量限制

k3s 默认的容器数量限制为 110，这可能不适用于比赛中的大量小容器，因此可以根据需要更改 k3s 的容器数量限制。

<Callout type="info">

Reference: [How do you increase maximum pods per node in K3S?](https://stackoverflow.com/questions/65894616/how-do-you-increase-maximum-pods-per-node-in-k3s)

</Callout>

在 k3s control-panel 所在的机器上执行以下命令：

- `sudo nano /etc/rancher/k3s/kubelet.config`
- 编辑如下设置中的 `maxPods`

  ```yaml
  apiVersion: kubelet.config.k8s.io/v1beta1
  kind: KubeletConfiguration
  maxPods: 500
  ```

- `sudo nano /etc/systemd/system/k3s.service`

- 编辑如下设置中的 `ExecStart`，指定`kubelet-arg`

  ```bash
  ExecStart=/usr/local/bin/k3s \
      server \
      --kubelet-arg=config=/etc/rancher/k3s/kubelet.config
  ```

- `sudo systemctl daemon-reload`
- `sudo systemctl restart k3s`

<Callout type="info">

如果需要在一台 k3s 实例上运行超过 255 个 Pod 可能会超过默认的子网大小，需要在安装 k3s 时指定 `INSTALL_K3S_EXEC`，并更改 `node-cidr-mask-size` 为所需的子网大小。

```bash
INSTALL_K3S_EXEC="--kube-controller-manager-arg=node-cidr-mask-size=16"
```

并使用如下格式安装 k3s，如需更多信息请参考 [k3s 安装配置](https://docs.k3s.io/installation/configuration)：

```bash
curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_EXEC="..." sh -
```

</Callout>

## 添加容器镜像仓库

直接使用外部的容器镜像仓库无法直接在 k3s 中使用，需要在 k3s 中添加镜像仓库。

在 k3s control-panel 所在的机器上执行以下命令：

- `sudo nano /etc/rancher/k3s/registries.yaml`

- 编辑如下设置中的 `mirrors`，指定你所需要的镜像仓库地址

  ```yaml
  mirrors:
    "container.ctf.example.com": # change this to your registry's domain
      endpoint:
        - "https://container.ctf.example.com" # change this to your registry's domain
  ```

- `sudo systemctl restart k3s`
